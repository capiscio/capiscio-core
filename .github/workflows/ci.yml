name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache: false
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.64.5
          args: --config=.golangci.yml

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'

      - name: Verify Dependencies
        run: go mod verify

      - name: Build
        run: go build -v ./...

      - name: Run Tests
        run: |
          # Run tests excluding generated protobuf code
          go test -v -race -coverprofile=coverage.txt -covermode=atomic \
            $(go list ./pkg/... ./internal/... | grep -v /gen/)

      - name: Check Coverage Threshold
        run: |
          # Parse coverage from profile
          COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: $COVERAGE%"
          
          # Check minimum threshold (65% for library code - RPC layer has integration test coverage)
          THRESHOLD=65
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "❌ Coverage $COVERAGE% is below minimum threshold of $THRESHOLD%"
            exit 1
          fi
          echo "✅ Coverage $COVERAGE% meets minimum threshold of $THRESHOLD%"

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.txt
          flags: unittests
          name: capiscio-core
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: capiscio_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout capiscio-core
        uses: actions/checkout@v4
        with:
          path: capiscio-core
      
      - name: Checkout capiscio-server
        uses: actions/checkout@v4
        with:
          repository: capiscio/capiscio-server
          path: capiscio-server
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache: true
          cache-dependency-path: |
            capiscio-core/go.sum
            capiscio-server/go.sum
      
      - name: Build capiscio-server
        run: |
          cd capiscio-server
          go build -o bin/server ./cmd/server/
      
      - name: Build capiscio-core CLI
        run: |
          cd capiscio-core
          make build-cli
      
      - name: Start server and seed test data
        run: |
          cd capiscio-server
          ./bin/server > server.log 2>&1 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Wait for server to be ready
          echo "Waiting for server..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
              echo "✓ Server is ready"
              break
            fi
            sleep 1
          done
          
          # Verify server is healthy
          curl -f http://localhost:8080/health || (cat server.log && exit 1)
          
          # Seed test data for integration tests
          PGPASSWORD=postgres psql -h localhost -U postgres -d capiscio_test <<'EOF'
          -- Create test user
          INSERT INTO users (id, clerk_user_id, email, deployment_id, created_at, updated_at)
          VALUES (
            '11111111-1111-1111-1111-111111111111',
            'user_test_integration',
            'integration@test.capiscio.local',
            'integration-test-deployment',
            NOW(),
            NOW()
          )
          ON CONFLICT (clerk_user_id) DO NOTHING;
          
          -- Create test organization
          INSERT INTO orgs (id, name, slug, plan, identity_limit, created_at, updated_at)
          VALUES (
            '22222222-2222-2222-2222-222222222222',
            'Integration Test Org',
            'integration-test-org',
            'developer',
            100,
            NOW(),
            NOW()
          )
          ON CONFLICT (slug) DO NOTHING;
          
          -- Create org membership
          INSERT INTO org_members (org_id, user_id, email, display_name, role, status, joined_at, updated_at)
          VALUES (
            '22222222-2222-2222-2222-222222222222',
            '11111111-1111-1111-1111-111111111111',
            'integration@test.capiscio.local',
            'Integration Test User',
            'admin',
            'active',
            NOW(),
            NOW()
          )
          ON CONFLICT (org_id, user_id) DO NOTHING;
          EOF
          echo "✓ Test data seeded"
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/capiscio_test?sslmode=disable
          PORT: 8080
          CAPISCIO_TEST_MODE: "true"
          CA_ISSUER_URL: https://registry.capisc.io
      
      - name: Run integration tests
        run: |
          cd capiscio-core
          # Add CLI to PATH
          export PATH="$PWD/bin:$PATH"
          
          # Run integration tests
          go test -v ./tests/integration/...
        env:
          API_BASE_URL: http://localhost:8080
          CAPISCIO_TEST_MODE: "true"
      
      - name: Show server logs
        if: always()
        run: |
          echo "=== Server Logs ==="
          cat capiscio-server/server.log || echo "No server logs found"
          echo "=== End Server Logs ==="
      
      - name: Cleanup
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || true
          fi
